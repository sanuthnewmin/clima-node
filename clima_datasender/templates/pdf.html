<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ESP32 Weather Dashboard</title>
<style>
  body {
    background-color: #0b0e14;
    color: #e2e8f0;
    font-family: "Segoe UI", sans-serif;
    margin: 0;
  }

  header {
    text-align: center;
    padding: 1rem;
    background: #111827;
    color: #60a5fa;
    font-size: 1.6rem;
    font-weight: bold;
    border-bottom: 2px solid #1e3a8a;
  }

  .connection {
    text-align: center;
    padding: 1rem;
  }

  button {
    background: #2563eb;
    border: none;
    color: white;
    padding: 0.6rem 1.2rem;
    border-radius: 6px;
    cursor: pointer;
    margin: 0.2rem;
  }
  button:hover { background: #1d4ed8; }

  .status {
    font-weight: bold;
    margin-left: 1rem;
  }
  .status.connected { color: #22c55e; }
  .status.disconnected { color: #ef4444; }

  .container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 1rem;
    padding: 1rem;
  }

  .card {
    background: #1f2937;
    padding: 1.2rem;
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.3);
  }

  .title {
    font-size: 1.1rem;
    color: #93c5fd;
  }

  .value {
    font-size: 2rem;
    font-weight: bold;
    margin-top: 0.4rem;
  }

  .unit {
    font-size: 1rem;
    color: #9ca3af;
  }

  .last-update {
    font-size: 0.85rem;
    color: #9ca3af;
    margin-top: 0.5rem;
  }

  #log {
    background: #111827;
    padding: 1rem;
    border-radius: 10px;
    height: 150px;
    overflow-y: auto;
    font-family: monospace;
    font-size: 0.9rem;
    color: #9ca3af;
    margin: 1rem;
  }
</style>
</head>
<body>

<header>ðŸŒ¦ ESP32 Weather Dashboard</header>

<div class="connection">
  <button id="connectBtn">Connect</button>
  <button id="disconnectBtn">Disconnect</button>
  <span id="status" class="status disconnected">Disconnected</span>
</div>

<div class="container">
  <div class="card">
    <div class="title">Temperature</div>
    <div class="value" id="temp">--</div>
    <div class="unit">Â°C</div>
    <div class="last-update" id="tempTime">last: --</div>
  </div>

  <div class="card">
    <div class="title">Humidity</div>
    <div class="value" id="hum">--</div>
    <div class="unit">%</div>
    <div class="last-update" id="humTime">last: --</div>
  </div>

  <div class="card">
    <div class="title">Pressure</div>
    <div class="value" id="press">--</div>
    <div class="unit">hPa</div>
    <div class="last-update" id="pressTime">last: --</div>
  </div>

  <div class="card">
    <div class="title">Battery</div>
    <div class="value" id="battery">--</div>
    <div class="unit">V</div>
    <div class="last-update" id="batteryTime">last: --</div>
  </div>
</div>

<div id="log"></div>

<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script>
  const broker = "wss://broker.emqx.io:8084/mqtt";
  const options = {
    clientId: "WebClient_" + Math.random().toString(16).substr(2, 8),
    keepalive: 60,
    reconnectPeriod: 3000,
  };

  const topics = {
    bmp: "esp32/sensor/bmp280",
    aht: "esp32/sensor/aht10",
    battery: "esp32/sensor/battery_capacity"
  };

  let client;
  const statusEl = document.getElementById("status");
  const logEl = document.getElementById("log");

  function log(msg) {
    const t = new Date().toLocaleTimeString();
    logEl.innerHTML += `[${t}] ${msg}<br>`;
    logEl.scrollTop = logEl.scrollHeight;
  }

  function updateCard(id, value, timeId) {
    document.getElementById(id).textContent = value;
    document.getElementById(timeId).textContent = "last: " + new Date().toLocaleTimeString();
  }

  document.getElementById("connectBtn").addEventListener("click", () => {
    client = mqtt.connect(broker, options);
    log("Connecting to broker...");

    client.on("connect", () => {
      log("âœ… Connected to broker!");
      statusEl.textContent = "Connected";
      statusEl.classList.add("connected");
      statusEl.classList.remove("disconnected");
      client.subscribe(Object.values(topics), err => {
        if (!err) log("Subscribed to all topics.");
      });
    });

    client.on("message", (topic, message) => {
      log(`ðŸ“© ${topic}: ${message}`);
      try {
        const payload = JSON.parse(message.toString());

        if (topic === topics.bmp) {
          updateCard("temp", payload.temperature.toFixed(1), "tempTime");
          updateCard("press", payload.pressure.toFixed(1), "pressTime");
        }
        if (topic === topics.aht) {
          updateCard("hum", payload.humidity.toFixed(1), "humTime");
        }
        if (topic === topics.battery) {
          updateCard("battery", payload.battery_voltage.toFixed(2), "batteryTime");
        }

      } catch (err) {
        log("âš ï¸ JSON parse error");
      }
    });

    client.on("error", err => {
      log("âŒ Connection error: " + err.message);
    });

    client.on("close", () => {
      statusEl.textContent = "Disconnected";
      statusEl.classList.remove("connected");
      statusEl.classList.add("disconnected");
      log("ðŸ”Œ Connection closed.");
    });
  });

  document.getElementById("disconnectBtn").addEventListener("click", () => {
    if (client) {
      client.end();
      statusEl.textContent = "Disconnected";
      statusEl.classList.remove("connected");
      statusEl.classList.add("disconnected");
      log("ðŸ”Œ Disconnected manually.");
    }
  });
</script>
</body>
</html>
