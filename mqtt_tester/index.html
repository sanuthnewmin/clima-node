<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClimaHA Weather Station Monitor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mqtt/4.3.7/mqtt.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @keyframes flow {
            to { stroke-dashoffset: -20; }
        }
        .flow-line {
            stroke-dasharray: 5, 5;
            stroke-width: 3;
            fill: none;
            stroke: #94a3b8; /* Default Gray */
            transition: stroke 0.5s;
        }
        .flow-active {
            stroke: #22c55e; /* Green */
            animation: flow 1s linear infinite;
        }
        .solar-active { color: #facc15; text-shadow: 0 0 10px #facc15; }
        .battery-charging { animation: pulse 2s infinite; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-100 min-h-screen p-4 md:p-8">

    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <header class="flex justify-between items-center mb-8 bg-slate-800 p-6 rounded-2xl border border-slate-700 shadow-xl">
            <div>
                <h1 class="text-2xl font-bold text-white">ClimaHA Node</h1>
                <p class="text-slate-400 text-sm">Live MQTT Monitoring</p>
            </div>
            <div id="status" class="flex items-center gap-2 px-4 py-2 rounded-full bg-red-500/10 text-red-500 border border-red-500/20">
                <div class="w-3 h-3 rounded-full bg-red-500 animate-pulse"></div>
                <span class="text-xs font-bold uppercase tracking-wider">Disconnected</span>
            </div>
        </header>

        <!-- Power Flow Diagram (The Animation Section) -->
        <div class="bg-slate-800 p-8 rounded-3xl border border-slate-700 shadow-xl mb-8">
            <h2 class="text-lg font-semibold mb-10 flex items-center gap-2">
                <i class="fas fa-bolt-lightning text-yellow-400"></i> Power System Dynamics
            </h2>
            
            <div class="relative flex justify-between items-center max-w-4xl mx-auto h-48">
                <!-- Solar Panel -->
                <div class="flex flex-col items-center z-10">
                    <div id="solar-icon" class="text-5xl text-slate-600 transition-colors duration-500">
                        <i class="fas fa-solar-panel"></i>
                    </div>
                    <span class="mt-2 font-bold" id="val-solar">0.0V</span>
                    <span class="text-xs text-slate-400">SOLAR</span>
                </div>

                <!-- Battery -->
                <div class="flex flex-col items-center z-10">
                    <div id="batt-icon" class="text-5xl text-slate-600 transition-colors duration-500">
                        <i class="fas fa-battery-three-quarters"></i>
                    </div>
                    <span class="mt-2 font-bold" id="val-batt">0.0V</span>
                    <span class="text-xs text-slate-400">BATTERY</span>
                </div>

                <!-- Load (Bulb) -->
                <div class="flex flex-col items-center z-10">
                    <div id="load-icon" class="text-5xl text-slate-600 transition-colors duration-500">
                        <i class="fas fa-lightbulb"></i>
                    </div>
                    <span class="mt-2 font-bold">Active</span>
                    <span class="text-xs text-slate-400">SYSTEM LOAD</span>
                </div>

                <!-- SVG Lines for Animations -->
                <svg class="absolute inset-0 w-full h-full pointer-events-none" style="z-index: 0;">
                    <!-- Solar to Battery -->
                    <path id="line-solar-batt" d="M 60 80 Q 200 80 380 80" class="flow-line" />
                    <!-- Battery to Load -->
                    <path id="line-batt-load" d="M 450 80 Q 600 80 750 80" class="flow-line" />
                    <!-- Direct Solar to Load (Optional visual) -->
                    <path id="line-solar-load" d="M 60 80 Q 400 -20 750 80" class="flow-line" style="opacity: 0.3;" />
                </svg>
            </div>
        </div>

        <!-- Sensor Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            <!-- Temperature -->
            <div class="bg-slate-800 p-6 rounded-2xl border border-slate-700">
                <div class="flex items-center gap-4">
                    <div class="p-3 bg-orange-500/10 rounded-lg text-orange-500"><i class="fas fa-thermometer-half text-2xl"></i></div>
                    <div>
                        <p class="text-slate-400 text-sm">Temperature</p>
                        <h3 class="text-2xl font-bold" id="val-temp">--°C</h3>
                    </div>
                </div>
            </div>

            <!-- Humidity -->
            <div class="bg-slate-800 p-6 rounded-2xl border border-slate-700">
                <div class="flex items-center gap-4">
                    <div class="p-3 bg-blue-500/10 rounded-lg text-blue-500"><i class="fas fa-droplet text-2xl"></i></div>
                    <div>
                        <p class="text-slate-400 text-sm">Humidity</p>
                        <h3 class="text-2xl font-bold" id="val-hum">--%</h3>
                    </div>
                </div>
            </div>

            <!-- Pressure -->
            <div class="bg-slate-800 p-6 rounded-2xl border border-slate-700">
                <div class="flex items-center gap-4">
                    <div class="p-3 bg-purple-500/10 rounded-lg text-purple-500"><i class="fas fa-gauge-high text-2xl"></i></div>
                    <div>
                        <p class="text-slate-400 text-sm">Pressure</p>
                        <h3 class="text-1xl font-bold leading-tight" id="val-press">-- hPa</h3>
                    </div>
                </div>
            </div>

            <!-- Rainfall -->
            <div class="bg-slate-800 p-6 rounded-2xl border border-slate-700 text-white relative overflow-hidden">
                <div class="flex items-center gap-4 relative z-10">
                    <div class="p-3 bg-cyan-500/10 rounded-lg text-cyan-500"><i class="fas fa-cloud-showers-heavy text-2xl"></i></div>
                    <div>
                        <p class="text-slate-400 text-sm">Total Rainfall</p>
                        <h3 class="text-2xl font-bold" id="val-rain">-- mm</h3>
                    </div>
                </div>
            </div>
        </div>

        <!-- Control Center -->
        <div class="mt-8 bg-slate-800 p-6 rounded-2xl border border-slate-700">
            <h2 class="font-semibold mb-4">Remote Commands</h2>
            <div class="flex gap-4">
                <button onclick="sendCommand('clear_rain')" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg font-medium transition">Clear Rain Counter</button>
                <button onclick="sendCommand('restart')" class="px-6 py-2 bg-red-600/20 text-red-500 hover:bg-red-600 hover:text-white border border-red-500/50 rounded-lg font-medium transition">Restart ESP32</button>
            </div>
        </div>
    </div>

    <script>
        // MQTT Configuration
        const broker = 'wss://broker.emqx.io:8084/mqtt'; // Use Secure WebSockets
        const options = {
            clientId: 'web_dash_' + Math.random().toString(16).substr(2, 8),
            clean: true
        };

        const client = mqtt.connect(broker, options);

        const topics = [
            'esp32/sensor/bmp280',
            'esp32/sensor/aht10',
            'esp32/sensor/rain',
            'esp32/sensor/power'
        ];

        client.on('connect', () => {
            console.log('Connected to MQTT');
            document.getElementById('status').className = "flex items-center gap-2 px-4 py-2 rounded-full bg-green-500/10 text-green-500 border border-green-500/20";
            document.getElementById('status').innerHTML = '<div class="w-3 h-3 rounded-full bg-green-500"></div><span class="text-xs font-bold uppercase tracking-wider">Online</span>';
            
            topics.forEach(t => client.subscribe(t));
        });

        client.on('message', (topic, message) => {
            const data = JSON.parse(message.toString());
            console.log(topic, data);

            if (topic === 'esp32/sensor/bmp280') {
                document.getElementById('val-press').innerText = data.press + ' hPa';
            }
            if (topic === 'esp32/sensor/aht10') {
                document.getElementById('val-temp').innerText = data.temp + '°C';
                document.getElementById('val-hum').innerText = data.hum + '%';
            }
            if (topic === 'esp32/sensor/rain') {
                document.getElementById('val-rain').innerText = data.mm.toFixed(2) + ' mm';
            }
            if (topic === 'esp32/sensor/power') {
                updatePowerSystem(data.batt, data.solar);
            }
        });

        function updatePowerSystem(batt, solar) {
            document.getElementById('val-batt').innerText = batt.toFixed(2) + 'V';
            document.getElementById('val-solar').innerText = solar.toFixed(2) + 'V';

            const solarIcon = document.getElementById('solar-icon');
            const battIcon = document.getElementById('batt-icon');
            const loadIcon = document.getElementById('load-icon');
            
            const lineSolarBatt = document.getElementById('line-solar-batt');
            const lineBattLoad = document.getElementById('line-batt-load');

            // 1. Solar State Logic (Is it Day or Night?)
            const isSolarActive = solar > 3.0; // Threshold for solar presence
            if (isSolarActive) {
                solarIcon.classList.add('solar-active', 'fa-spin');
                solarIcon.style.animationDuration = '10s';
            } else {
                solarIcon.classList.remove('solar-active', 'fa-spin');
            }

            // 2. Charging Logic (Is Solar charging the Battery?)
            if (solar > (batt + 0.2)) { // Charging if solar > battery + margin
                lineSolarBatt.classList.add('flow-active');
                battIcon.classList.add('battery-charging', 'text-green-500');
            } else {
                lineSolarBatt.classList.remove('flow-active');
                battIcon.classList.remove('battery-charging', 'text-green-500');
            }

            // 3. Load Drive Logic (Is system running?)
            if (batt > 3.0 || solar > 3.0) {
                lineBattLoad.classList.add('flow-active');
                loadIcon.classList.add('text-yellow-400');
                loadIcon.classList.add('animate-pulse');
            } else {
                lineBattLoad.classList.remove('flow-active');
                loadIcon.classList.remove('text-yellow-400', 'animate-pulse');
            }

            // 4. Color Coding Battery
            if (batt < 3.4) battIcon.className = "fas fa-battery-empty text-red-500 text-5xl";
            else if (batt < 3.8) battIcon.className = "fas fa-battery-half text-yellow-500 text-5xl";
            else battIcon.className = "fas fa-battery-full text-green-500 text-5xl";
        }

        function sendCommand(cmd) {
            client.publish('esp32/cmd/control', cmd);
            alert('Command sent: ' + cmd);
        }

        client.on('close', () => {
            document.getElementById('status').className = "flex items-center gap-2 px-4 py-2 rounded-full bg-red-500/10 text-red-500 border border-red-500/20";
            document.getElementById('status').innerHTML = '<div class="w-3 h-3 rounded-full bg-red-500 animate-pulse"></div><span class="text-xs font-bold uppercase tracking-wider">Disconnected</span>';
        });
    </script>
</body>
</html>